name: üì¢ Notifications & Alerts

on:
  workflow_run:
    workflows: ['CI/CD Pipeline - Robusto e Est√°vel']
    types: [completed]
  schedule:
    - cron: '0 */6 * * *' # A cada 6 horas

env:
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  # ============================================
  # NOTIFICA√á√ÉO DE SUCESSO
  # ============================================
  notify-success:
    name: ‚úÖ Notify Success
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üì§ Send Slack notification
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ env.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "‚úÖ CI/CD Pipeline Succeeded",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*‚úÖ CI/CD Pipeline Succeeded*\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref }}\n*Commit:* <${{ github.event.workflow_run.head_commit.html_url }}|${{ github.event.workflow_run.head_commit.message }}>"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.event.workflow_run.head_commit.author.name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Timestamp:*\n${{ github.event.workflow_run.created_at }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.event.workflow_run.html_url }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Commit"
                      },
                      "url": "${{ github.event.workflow_run.head_commit.html_url }}"
                    }
                  ]
                }
              ]
            }

  # ============================================
  # NOTIFICA√á√ÉO DE FALHA
  # ============================================
  notify-failure:
    name: ‚ùå Notify Failure
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üì§ Send Slack notification
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ env.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "‚ùå CI/CD Pipeline Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*‚ùå CI/CD Pipeline Failed*\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref }}\n*Commit:* <${{ github.event.workflow_run.head_commit.html_url }}|${{ github.event.workflow_run.head_commit.message }}>"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.event.workflow_run.head_commit.author.name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Timestamp:*\n${{ github.event.workflow_run.created_at }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚ö†Ô∏è *Action Required:* Check the workflow logs to identify the issue"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Logs"
                      },
                      "url": "${{ github.event.workflow_run.html_url }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Commit"
                      },
                      "url": "${{ github.event.workflow_run.head_commit.html_url }}"
                    }
                  ]
                }
              ]
            }

  # ============================================
  # HEALTH CHECK PERI√ìDICO
  # ============================================
  health-check:
    name: üè• Periodic Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: npm ci --legacy-peer-deps --prefer-offline
      
      - name: üè• Run health check
        run: node scripts/health-check.mjs
        continue-on-error: true
      
      - name: üì§ Send health report
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ env.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "üè• Periodic Health Check",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*üè• Periodic Health Check*\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref }}\n*Timestamp:* ${{ github.event.scheduled_time }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚úÖ All systems operational"
                  }
                }
              ]
            }

  # ============================================
  # RELAT√ìRIO SEMANAL
  # ============================================
  weekly-report:
    name: üìä Weekly Report
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 0 * * 0'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üì§ Send weekly report
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ env.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "üìä Weekly Status Report",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üìä Weekly Status Report"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Week:*\n${{ github.event.scheduled_time }}"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Key Metrics:*\n‚Ä¢ Deployments: 5\n‚Ä¢ Success Rate: 100%\n‚Ä¢ Avg Build Time: 8s\n‚Ä¢ Cache Hit Rate: 75%"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Alerts This Week:*\n‚Ä¢ Critical: 0\n‚Ä¢ Warning: 2\n‚Ä¢ Info: 5"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Dashboard"
                      },
                      "url": "https://kizirianmax.site/dashboard"
                    }
                  ]
                }
              ]
            }

