name: üöÄ CI/CD Pipeline - Robusto e Est√°vel

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 0 * * 0' # Weekly check

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18.x'
  NPM_CACHE_DIR: ~/.npm
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ============================================
  # 1. SETUP E VALIDA√á√ÉO
  # ============================================
  setup:
    name: üîß Setup Environment
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      node-version: ${{ env.NODE_VERSION }}
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üîë Generate cache key
        id: cache-key
        run: echo "key=node-${{ hashFiles('**/package-lock.json') }}" >> $GITHUB_OUTPUT
      
      - name: üìä Print environment info
        run: |
          echo "Node version: ${{ env.NODE_VERSION }}"
          echo "GitHub ref: ${{ github.ref }}"
          echo "GitHub event: ${{ github.event_name }}"
          echo "Runner OS: ${{ runner.os }}"

  # ============================================
  # 2. INSTALAR DEPEND√äNCIAS
  # ============================================
  install:
    name: üì¶ Install Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: setup
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json
      
      - name: üì¶ Install dependencies
        run: |
          npm ci --legacy-peer-deps --prefer-offline --no-audit
        timeout-minutes: 5
      
      - name: ‚úÖ Verify installation
        run: |
          npm list --depth=0
          node --version
          npm --version

  # ============================================
  # 3. LINTING E FORMATA√á√ÉO
  # ============================================
  lint:
    name: üîç Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: install
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: npm ci --legacy-peer-deps --prefer-offline
      
      - name: üîç Run ESLint
        run: npm run lint || true
        continue-on-error: true
      
      - name: üìù Check formatting
        run: npm run format:check || true
        continue-on-error: true

  # ============================================
  # 4. TESTES
  # ============================================
  test:
    name: üß™ Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: install
    
    strategy:
      matrix:
        test-type: [unit, integration]
      fail-fast: false
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: npm ci --legacy-peer-deps --prefer-offline
      
      - name: üß™ Run tests (${{ matrix.test-type }})
        run: |
          if [ "${{ matrix.test-type }}" = "unit" ]; then
            node test-hybrid-system.mjs
          else
            npm test -- --testPathPattern=integration || true
          fi
        timeout-minutes: 5
        continue-on-error: true
      
      - name: üìä Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.test-type }}
          path: coverage/
          retention-days: 7

  # ============================================
  # 5. BUILD
  # ============================================
  build:
    name: üèóÔ∏è Build Application
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [install, lint, test]
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: npm ci --legacy-peer-deps --prefer-offline
      
      - name: üèóÔ∏è Build application
        run: npm run build
        timeout-minutes: 5
        env:
          CI: true
          GENERATE_SOURCEMAP: false
      
      - name: üìä Check bundle size
        run: |
          BUILD_SIZE=$(du -sh build/ | cut -f1)
          echo "Build size: $BUILD_SIZE"
          
          # Verificar limite (12 MB para Vercel FREE)
          SIZE_BYTES=$(du -sb build/ | cut -f1)
          LIMIT_BYTES=$((12 * 1024 * 1024))
          
          if [ $SIZE_BYTES -gt $LIMIT_BYTES ]; then
            echo "‚ùå Build size exceeds limit!"
            exit 1
          fi
      
      - name: üì¶ Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build
          path: build/
          retention-days: 7

  # ============================================
  # 6. SEGURAN√áA
  # ============================================
  security:
    name: üîê Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: install
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: npm ci --legacy-peer-deps --prefer-offline
      
      - name: üîê Run security audit
        run: npm audit --audit-level=moderate || true
        continue-on-error: true
      
      - name: üîç Check for vulnerabilities
        run: npm audit fix --dry-run || true
        continue-on-error: true

  # ============================================
  # 7. AN√ÅLISE DE C√ìDIGO
  # ============================================
  analyze:
    name: üìà Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: npm ci --legacy-peer-deps --prefer-offline
      
      - name: üìä Analyze bundle
        run: npm run build -- --analyze || true
        continue-on-error: true
      
      - name: üìà Generate report
        run: |
          echo "## Build Analysis Report" > analysis.md
          echo "" >> analysis.md
          echo "- Build time: $(date)" >> analysis.md
          echo "- Node version: $(node --version)" >> analysis.md
          echo "- npm version: $(npm --version)" >> analysis.md
      
      - name: üì§ Upload analysis
        uses: actions/upload-artifact@v3
        with:
          name: analysis-report
          path: analysis.md

  # ============================================
  # 8. DEPLOY PARA VERCEL
  # ============================================
  deploy:
    name: üöÄ Deploy to Vercel
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [test, build, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üöÄ Deploy to Vercel
        uses: vercel/action@main
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          production: true
        timeout-minutes: 5
      
      - name: ‚úÖ Deployment successful
        run: echo "‚úÖ Deployment to Vercel completed!"

  # ============================================
  # 9. NOTIFICA√á√ïES
  # ============================================
  notify:
    name: üì¢ Notify Status
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [setup, install, lint, test, build, security, analyze, deploy]
    if: always()
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üìä Generate summary
        run: |
          echo "## CI/CD Pipeline Summary" > summary.md
          echo "" >> summary.md
          echo "- **Status**: ${{ job.status }}" >> summary.md
          echo "- **Commit**: ${{ github.sha }}" >> summary.md
          echo "- **Branch**: ${{ github.ref }}" >> summary.md
          echo "- **Author**: ${{ github.actor }}" >> summary.md
          echo "- **Time**: $(date)" >> summary.md
      
      - name: üì§ Upload summary
        uses: actions/upload-artifact@v3
        with:
          name: pipeline-summary
          path: summary.md
      
      - name: üîî Notify on failure
        if: failure()
        run: |
          echo "‚ùå CI/CD Pipeline failed!"
          echo "Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

# ============================================
# CACHE STRATEGY
# ============================================
# - npm cache: ~/.npm
# - node_modules: Automatic via actions/setup-node
# - build artifacts: Uploaded for 7 days
# - test results: Uploaded for 7 days

# ============================================
# TIMEOUT STRATEGY
# ============================================
# - Setup: 5 min
# - Install: 10 min
# - Lint: 5 min
# - Test: 10 min
# - Build: 10 min
# - Security: 10 min
# - Analyze: 10 min
# - Deploy: 10 min
# - Total: ~70 min (within GitHub Actions limit)

# ============================================
# RETRY STRATEGY
# ============================================
# - Transient failures: Automatic retry
# - Permanent failures: Fail fast
# - continue-on-error: For non-critical steps

# ============================================
# MONITORING
# ============================================
# - All artifacts uploaded for 7 days
# - Logs available in GitHub Actions
# - Email notifications on failure
# - Slack integration (optional)

